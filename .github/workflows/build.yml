name: üë∑‚Äç‚ôÄÔ∏è Build, sign and create installers

on: [push, pull_request]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: RelWithDebInfo
  

jobs:

  build:
    name: üõ† üçé üì∫ Build for macOS & Windows
    runs-on: ${{ matrix.os.runner }}
    
    strategy:
      matrix:
        os:
        - runner: macos-10.15
          name: mac
        - runner: windows-latest
          name: windows

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    # We are creating the ${{runner.workspace}}/build directory to perform the build
    - name: Configure CMake
      working-directory: ${{ runner.workspace }}
      run: cmake -S Schrammel_OJD -B ${{ runner.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build
      working-directory: ${{ runner.workspace }}/build
      run: cmake --build . --config ${{ env.BUILD_TYPE }}

    - name: Upload build artefacts
      uses: actions/upload-artifact@v2.2.1
      with:
        name: OJD-${{ matrix.os.name }}
        path: |
              ${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}
              !${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}/**/*.a
              !${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}/**/*.lib

    - name: Upload installer files
      uses: actions/upload-artifact@v2.2.1
      with:
        name: InstallerFiles-${{ matrix.os.name }}
        path: ${{ runner.workspace }}/Schrammel_OJD/Deployment/${{ matrix.os.name }}


  codesign_mac:
      name: üîè üçé Sign Artefacts for macOS
      runs-on: macos-10.15
      needs: build
      steps:
        - name: Download macOS build artefacts from previous job
          uses: actions/download-artifact@v2
          with: 
            name: OJD-mac

        - name: Setup temporary application signing keychain
          uses: apple-actions/import-codesign-certs@v1
          with: 
            p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_APPLICATION }}
            p12-password: ${{ secrets.APPLE_CERTIFICATE_PW }}

        - name: Codesign AU plugin
          run: codesign -s "${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}" AU/OJD.component --timestamp

        - name: Codesign VST3 plugin
          run: codesign -s "${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}" VST3/OJD.vst3 --timestamp

        - name: Upload artefacts
          uses: actions/upload-artifact@v2.2.1
          with:
            name: OJD-mac-signed
            path: |
              AU
              VST3


  installer_mac:
      name: üì¶ üçé Build installer for macOS
      runs-on: macos-10.15
      needs: codesign_mac
      steps:
        - name: Download signed macOS build artefacts from previous job
          uses: actions/download-artifact@v2
          with: 
            name: OJD-mac-signed

        - name: Download installer files
          uses: actions/download-artifact@v2
          with: 
            name: InstallerFiles-mac
        
        - name: Download Packages
          run: wget http://s.sudre.free.fr/Software/files/Packages.dmg

        - name: Mount Packages image
          run: hdiutil attach Packages.dmg

        - name: Install Packages
          run: sudo installer -pkg /Volumes/Packages\ 1.2.9/Install\ Packages.pkg -target /

        - name: Setup temporary installer signing keychain
          uses: apple-actions/import-codesign-certs@v1
          with: 
            p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_INSTALLER }}
            p12-password: ${{ secrets.APPLE_CERTIFICATE_PW }}

        - name: Build Installer
          run: packagesbuild --verbose Schrammel\ OJD.pkgproj

        - name: What did we produce?
          run: ls

        - name: Sign Installer
          run: productsign --sign "${{ secrets.APPLE_DEVELOPER_ID_INSTALLER }}" OJD/Schrammel\ OJD.pkg Install\ OJD.pkg
          
        - name: What did we produce again?
          run: ls