name: üë∑‚Äç‚ôÄÔ∏è Build, sign and create installers

on: [push, pull_request]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: RelWithDebInfo
  

jobs:

  # The Matrix job for the compilation itself, executed on all supported OS
  build:
    name: üõ† üçé üì∫ Build for macOS & Windows
    runs-on: ${{ matrix.os.runner }}
    
    strategy:
      matrix:
        os:
        - runner: macos-10.15
          name: mac
        - runner: windows-latest
          name: windows

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    # We are creating the ${{runner.workspace}}/build directory to perform the build
    - name: Configure CMake
      working-directory: ${{ runner.workspace }}
      run: cmake -S Schrammel_OJD -B ${{ runner.workspace }}/build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build
      working-directory: ${{ runner.workspace }}/build
      run: cmake --build . --config ${{ env.BUILD_TYPE }}

    - name: Upload build artefacts and installer support files
      uses: actions/upload-artifact@v2.2.1
      with:
        name: OJD-build-output-${{ matrix.os.name }}
        path: |
              ${{ runner.workspace }}/Schrammel_OJD/Deployment/${{ matrix.os.name }}
              ${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}
              !${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}/**/*.a
              !${{ runner.workspace }}/build/OJD_artefacts/${{ env.BUILD_TYPE }}/**/*.lib


  # The macOS specific deployment task that signs the plugins, builds the installer, signs and notarizes it
  # and finally creates a disk image containing the notarized installer
  deployment_mac:
      name: üì¶ üçé Deployment tasks for macOS
      runs-on: macos-10.15
      needs: build
      steps:
        - name: Download macOS build artefacts from previous job
          uses: actions/download-artifact@v2
          with: 
            name: OJD-build-output-mac

        - name: Setup temporary keychain and add application signing certificate
          uses: apple-actions/import-codesign-certs@v1
          with: 
            p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_APPLICATION }}
            p12-password: ${{ secrets.APPLE_CERTIFICATE_PW }}

        - name: Temporarily lock keychain again to work around an issue in the next step
          run: security lock-keychain signing_temp.keychain

        - name: Add installer signing certificate to temporary keychain
          uses: apple-actions/import-codesign-certs@v1
          with: 
            create-keychain: false
            p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_INSTALLER }}
            p12-password: ${{ secrets.APPLE_CERTIFICATE_PW }}

        - name: Codesign AU plugin
          run: codesign -s "${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}" AU/OJD.component --timestamp

        - name: Codesign VST3 plugin
          run: codesign -s "${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}" VST3/OJD.vst3 --timestamp

        - name: Upload signed artefacts
          uses: actions/upload-artifact@v2.2.1
          with:
            name: OJD-mac-signed
            path: |
              AU
              VST3
        
        - name: Download Packages installer build tool
          run: wget http://s.sudre.free.fr/Software/files/Packages.dmg

        - name: Mount Packages image
          run: hdiutil attach Packages.dmg

        - name: Install Packages
          run: sudo installer -pkg /Volumes/Packages\ 1.2.9/Install\ Packages.pkg -target /

        - name: Build installer
          run: packagesbuild Schrammel\ OJD.pkgproj

        - name: Create folder for signed installer
          run: mkdir OJD-Signed

        - name: Sign installer
          run: productsign -s "${{ secrets.APPLE_DEVELOPER_ID_INSTALLER }}" OJD/Schrammel\ OJD.pkg OJD-Signed/Install\ OJD.pkg
          
        - name: Notarize installer
          run: npx notarize-cli --file "OJD-Signed/Install\ OJD.pkg"
          env:
            NOTARIZE_USERNAME: ${{ secrets.APPLE_ID }}
            NOTARIZE_PASSWORD: ${{ secrets.APPLE_NOTARIZATION_PW }}

        - name: Create DMG
          run: hdiutil create Install\ OJD.dmg -fs HFS+ -srcfolder OJD-Signed -format UDZO -volname Install\ OJD

        - name: Upload DMG
          uses: actions/upload-artifact@v2.2.1
          with:
            name: OJD-installer-mac
            path: Install\ OJD.dmg
